# Implement Next Step of Issue Plan

Implement the next step from an existing implementation plan on a GitHub issue.

## Usage

```
/ke:step [issue-number]
```

Issue number is optional if an issue has already been discussed in the current conversation.

## Instructions

You are tasked with implementing the NEXT incomplete step from an implementation plan on a GitHub issue.

### Step 0: Determine the Issue Number(s)

- If `$ARGUMENTS` is provided and non-empty, parse it for issue numbers
  - Multiple issue numbers can be provided (e.g., `42 43 44` or `42, 43, 44` or `#42 #43`)
  - Extract all numeric issue identifiers from the arguments
- Otherwise, infer the issue number using these sources (in priority order):
  1. Conversation context (previously discussed issue, URL mentioned, `gh issue view` output)
  2. Current branch name (e.g., `issue-42` or `fix-42` suggests issue #42)
  3. Recent commits referencing issues (e.g., `Fix #42` in commit messages)
  4. Open issues assigned to the current user (`gh issue list --assignee @me`)
  5. Recently updated open issues (`gh issue list --state open --limit 5`)
- If no issue number is provided, make your best guess based on the above sources, then **ask the user to confirm** before proceeding:
  ```
  No issue number provided. Based on [source], I believe you want to work on:
  - #42: [Issue title]

  Is this correct? (yes/no/specify different issue)
  ```

**If multiple issue numbers are provided:**
- Process each issue sequentially (complete all steps for issue 1, then all steps for issue 2, etc.)
- Track the outcome of each issue (success, failure, skipped, etc.)
- After processing ALL issues, provide a summary report (see "Final Summary Report" section at the end)

### Step 1: Fetch the Issue and Plan

Use `gh issue view <issue-number> --comments` to read the issue and find the implementation plan comment.

### Step 2: Identify the Next Step

Review the implementation plan and identify which step to work on next:
- Look for steps that haven't been marked as completed
- If steps are marked with checkboxes, find the first unchecked item
- If no checkboxes, determine progress from any status updates in the comments

### Step 3: Implement the Step

Implement ONLY the next single step:
- Make the necessary code changes
- Follow existing patterns and conventions in the codebase
- Keep changes focused and minimal

### Step 4: Update the Plan with Checkmarks

Update the original implementation plan comment to mark the completed step:

1. Find the comment ID of the implementation plan comment using:
   ```bash
   gh api repos/{owner}/{repo}/issues/{number}/comments --jq '.[] | select(.body | contains("## Implementation Plan")) | .id'
   ```

2. Get the current comment body and update it:
   - If steps use `- [ ]` checkbox format, change the completed step to `- [x]`
   - If steps use numbered list (`1.`, `2.`, etc.), add ✅ prefix to completed step

3. Update the comment using:
   ```bash
   gh api repos/{owner}/{repo}/issues/comments/{comment-id} -X PATCH -f body="<updated-body>"
   ```

**Example transformation:**
```markdown
# Before
### Implementation Steps
1. Add GraphQL mutation
2. Create Tauri command
3. Add frontend handler

# After
### Implementation Steps
1. ✅ Add GraphQL mutation
2. Create Tauri command
3. Add frontend handler
```

### Step 5: Post Progress Comment

Post a brief progress comment on the issue using `gh issue comment`:

```markdown
## Progress Update

Completed step [N] of [total]: **[Step description]**

### Changes Made
- `path/to/file.ts` - [brief description of change]

---
*Generated by Claude Code*
```

### Step 6: Ask for Review

After updating the issue, ask the user to review the changes before proceeding.

### Important

- Do NOT commit any changes
- Do NOT push any changes
- Implement only ONE step at a time
- Always ask the user to review before finishing
- If the plan is unclear or the next step is ambiguous, ask for clarification before implementing

### Final Summary Report (for multiple issues)

When multiple issues were processed, provide a summary table at the end:

```markdown
## Issues Processed

| Issue | Title | Status | Step Completed |
|-------|-------|--------|----------------|
| #42 | [Issue title] | ✅ Step done | Step 3 of 5 |
| #43 | [Issue title] | ✅ Step done | Step 1 of 3 |
| #44 | [Issue title] | ❌ Failed | No plan found |
| #45 | [Issue title] | ⏭️ Skipped | All steps complete |

### Summary
- **Steps completed:** 2
- **Failed:** 1
- **Skipped:** 1
```
