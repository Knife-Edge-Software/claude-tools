# Close GitHub Issue

Commit and push changes, then close the GitHub issue. If a worktree was created for this issue, merge it first and clean up.

## Usage

```
/ke:close [issue-number]
```

Issue number is optional if an issue has already been discussed in the current conversation.

## Instructions

You are tasked with finalizing work on a GitHub issue by committing changes, pushing to the remote, and closing the issue.

### Step 0: Determine the Issue Number(s)

- If `$ARGUMENTS` is provided and non-empty, parse it for issue numbers
  - Multiple issue numbers can be provided (e.g., `42 43 44` or `42, 43, 44` or `#42 #43`)
  - Extract all numeric issue identifiers from the arguments
- Otherwise, infer the issue number using these sources (in priority order):
  1. Conversation context (previously discussed issue, URL mentioned, `gh issue view` output)
  2. Current branch name (e.g., `issue-42` or `fix-42` suggests issue #42)
  3. Recent commits referencing issues (e.g., `Fix #42` in commit messages)
  4. Open issues assigned to the current user (`gh issue list --assignee @me`)
  5. Recently updated open issues (`gh issue list --state open --limit 5`)
- If no issue number is provided, make your best guess based on the above sources, then **ask the user to confirm** before proceeding:
  ```
  No issue number provided. Based on [source], I believe you want to work on:
  - #42: [Issue title]

  Is this correct? (yes/no/specify different issue)
  ```

**If multiple issue numbers are provided:**
- Process each issue sequentially (complete all steps for issue 1, then all steps for issue 2, etc.)
- Track the outcome of each issue (success, failure, skipped, etc.)
- After processing ALL issues, provide a summary report (see "Final Summary Report" section at the end)

### Step 1: Check for Worktree

Check if a worktree exists for this issue:
- Use `git worktree list` to see all worktrees
- Look for a worktree on branch `issue-<issue-number>`

**If a worktree exists:**
1. Note the worktree path and branch name
2. Ensure you are in the main worktree (not the issue worktree)
3. Follow Steps 2a-2c below for worktree handling
4. Then continue to Step 3

**If no worktree exists:**
- Skip to Step 2 (regular flow)

### Step 2: Review Changes

Use `git status` and `git diff` to review what changes are staged or unstaged.

### Step 2a: Commit Changes in Worktree (if applicable)

If working with a worktree:
1. Change to the worktree directory
2. Stage all relevant changes with `git add`
3. Create a commit with a descriptive message: `Fix #<issue-number>: <brief description>`
4. Return to the main worktree directory

### Step 2b: Merge Worktree Branch (if applicable)

From the main worktree:
1. Ensure main/master is up to date: `git fetch origin`
2. Checkout the target branch (usually main/master)
3. Merge the issue branch: `git merge issue-<issue-number>`
4. If there are conflicts, inform the user and help resolve them

### Step 2c: Remove Worktree (if applicable)

After successful merge:
1. Remove the worktree: `git worktree remove <worktree-path>`
2. Delete the branch: `git branch -d issue-<issue-number>`
3. Inform the user that the worktree has been cleaned up

### Step 3: Commit Changes (regular flow)

If not using a worktree (or after worktree merge):
- Stage all relevant changes with `git add`
- Create a commit with a descriptive message that references the issue number
- Use the format: `Fix #<issue-number>: <brief description>`

### Step 4: Push to Remote

Push the committed changes to the remote repository using `git push`.

### Step 5: Close the Issue

Close the issue using `gh issue close <issue-number>` with a comment summarizing what was done:

```markdown
## Closed

This issue has been resolved.

### Commit
[commit hash] - [commit message]

### Worktree Cleanup (if applicable)
- Branch `issue-<issue-number>` merged and deleted
- Worktree at `<path>` removed

---
*Generated by Claude Code*
```

### Important

- Always review changes before committing
- Ensure the commit message references the issue number
- If there are no changes to commit, inform the user and ask how to proceed
- If the push fails, inform the user of the error
- When merging worktree branches, always use a regular merge (not fast-forward only) to preserve history
- If worktree removal fails, inform the user of the specific error

### Final Summary Report (for multiple issues)

When multiple issues were processed, provide a summary table at the end:

```markdown
## Issues Processed

| Issue | Title | Status | Notes |
|-------|-------|--------|-------|
| #42 | [Issue title] | ✅ Closed | Merged from worktree |
| #43 | [Issue title] | ✅ Closed | Direct commit |
| #44 | [Issue title] | ❌ Failed | Push failed - auth error |
| #45 | [Issue title] | ⏭️ Skipped | No changes to commit |

### Summary
- **Closed:** 2
- **Failed:** 1
- **Skipped:** 1
```
